<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ - Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Firebase</title>
    <!-- Tailwind + Fonts + Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK (Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø©) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap');
        * { font-family: 'Cairo', sans-serif; }
        .gold-gradient { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        #reader { width: 100%; height: auto; border-radius: 1rem; overflow: hidden; border: 3px solid #eab308; }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #eab308;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            z-index: 9999;
            transition: all 0.3s;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
        
        .active-tab { background: #eab308; color: #0f172a; font-weight: 900; }
        .tab-btn { transition: all 0.3s; cursor: pointer; }
        .tab-btn:hover { background: rgba(234, 179, 8, 0.2); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen text-white">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingScreen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold text-amber-400">Ù…Ù†ØµØ© Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ</h2>
            <p class="text-gray-400 mt-2" id="loadingStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
    </div>

    <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div id="toast" class="hidden">
        <div class="glass text-white px-6 py-3 rounded-2xl flex items-center gap-3 shadow-2xl border-r-4 border-amber-400">
            <i class="fas fa-check-circle text-amber-400 text-xl"></i>
            <span id="toastMessage">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­</span>
        </div>
    </div>

    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="homePage" class="w-full max-w-4xl mx-auto p-4 min-h-screen flex items-center justify-center">
        <div class="text-center w-full">
            <div class="mb-8">
                <div class="w-32 h-32 bg-amber-400 rounded-3xl mx-auto mb-4 flex items-center justify-center shadow-2xl">
                    <i class="fas fa-graduation-cap text-6xl text-slate-900"></i>
                </div>
                <h1 class="text-6xl font-black text-white mb-2">
                    Ù…Ù†ØµØ© <span class="text-amber-400">Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ</span>
                </h1>
                <p class="text-xl text-gray-400">Ù…Ø³ØªØ± Ù…Ø­Ù…Ø¯ Ø±Ø³ØªÙ…</p>
            </div>

            <div class="max-w-md mx-auto glass p-8 rounded-3xl border border-amber-400/30">
                <div class="mb-6">
                    <select id="userType" class="w-full p-4 rounded-xl bg-slate-800 border-2 border-amber-400/30 text-white">
                        <option value="teacher">ğŸ‘¨â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³</option>
                        <option value="student">ğŸ‘¨â€ğŸ“ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</option>
                    </select>
                </div>
                <div class="mb-6">
                    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" 
                           class="w-full p-4 rounded-xl bg-slate-800 border-2 border-amber-400/30 text-white">
                </div>
                <button onclick="login()" class="w-full gold-gradient text-slate-900 font-black py-4 rounded-xl text-lg hover:scale-105 transition">
                    Ø¯Ø®ÙˆÙ„
                </button>
            </div>

            <div class="grid grid-cols-3 gap-4 mt-8">
                <div class="glass p-4 rounded-2xl">
                    <div class="text-2xl font-bold text-amber-400" id="homeStudentsCount">0</div>
                    <div class="text-sm text-gray-400">Ø·Ø§Ù„Ø¨</div>
                </div>
                <div class="glass p-4 rounded-2xl">
                    <div class="text-2xl font-bold text-blue-400" id="homeVideosCount">0</div>
                    <div class="text-sm text-gray-400">Ù…Ø­Ø§Ø¶Ø±Ø©</div>
                </div>
                <div class="glass p-4 rounded-2xl">
                    <div class="text-2xl font-bold text-green-400" id="homeAttendanceToday">0</div>
                    <div class="text-sm text-gray-400">Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ -->
    <div id="teacherPanel" class="hidden w-full max-w-7xl mx-auto p-4">
        <div class="glass sticky top-0 z-40 p-6 mb-6 rounded-2xl border border-amber-400/30">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black text-amber-400">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯Ø±Ø³</h2>
                    <p class="text-sm text-gray-400">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù…Ø³ØªØ± Ù…Ø­Ù…Ø¯</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openCamera()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700">
                        <i class="fas fa-camera ml-2"></i> ÙƒØ§Ù…ÙŠØ±Ø§
                    </button>
                    <button onclick="syncData()" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700">
                        <i class="fas fa-sync ml-2"></i> Ù…Ø²Ø§Ù…Ù†Ø©
                    </button>
                    <button onclick="logout()" class="bg-red-500/20 text-red-500 px-6 py-3 rounded-xl hover:bg-red-500/30">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-5 gap-4 mb-6">
            <div class="glass p-4 rounded-xl">
                <i class="fas fa-users text-3xl text-amber-400 mb-2"></i>
                <p class="text-sm text-gray-400">Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                <p id="totalStudents" class="text-3xl font-black">0</p>
            </div>
            <div class="glass p-4 rounded-xl">
                <i class="fas fa-video text-3xl text-blue-400 mb-2"></i>
                <p class="text-sm text-gray-400">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>
                <p id="totalVideos" class="text-3xl font-black">0</p>
            </div>
            <div class="glass p-4 rounded-xl">
                <i class="fas fa-eye text-3xl text-green-400 mb-2"></i>
                <p class="text-sm text-gray-400">Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</p>
                <p id="totalViews" class="text-3xl font-black">0</p>
            </div>
            <div class="glass p-4 rounded-xl">
                <i class="fas fa-calendar-check text-3xl text-purple-400 mb-2"></i>
                <p class="text-sm text-gray-400">Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</p>
                <p id="todayAttendance" class="text-3xl font-black">0</p>
            </div>
            <div class="glass p-4 rounded-xl">
                <i class="fas fa-percent text-3xl text-pink-400 mb-2"></i>
                <p class="text-sm text-gray-400">Ø§Ù„Ù†Ø³Ø¨Ø©</p>
                <p id="attendancePercentage" class="text-3xl font-black">0%</p>
            </div>
        </div>

        <div class="flex bg-slate-800 rounded-2xl overflow-hidden mb-6">
            <button onclick="showTab('students')" id="tabStudents" class="tab-btn active-tab flex-1 py-4 font-bold">ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            <button onclick="showTab('videos')" id="tabVideos" class="tab-btn flex-1 py-4 font-bold">ğŸ¬ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</button>
            <button onclick="showTab('attendance')" id="tabAttendance" class="tab-btn flex-1 py-4 font-bold">ğŸ“… Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ -->
        <div id="studentsSection" class="tab-section">
            <div class="glass p-6 rounded-2xl mb-6">
                <h3 class="font-bold mb-4 text-lg text-amber-400">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="stdName" placeholder="Ø§Ù„Ø§Ø³Ù…" class="p-3 rounded-xl bg-slate-700 text-white">
                    <input type="text" id="stdCode" placeholder="Ø§Ù„ÙƒÙˆØ¯" class="p-3 rounded-xl bg-slate-700 text-white">
                    <input type="text" id="stdParent" placeholder="ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" class="p-3 rounded-xl bg-slate-700 text-white">
                    <input type="text" id="stdCenter" placeholder="Ø§Ù„Ø³Ù†ØªØ±" class="p-3 rounded-xl bg-slate-700 text-white">
                    <select id="stdYear" class="p-3 rounded-xl bg-slate-700 text-white">
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                    </select>
                    <input type="text" id="stdGroup" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©" class="p-3 rounded-xl bg-slate-700 text-white">
                    <button onclick="addStudent()" class="bg-amber-500 text-slate-900 font-bold rounded-xl p-3 col-span-2">Ø­ÙØ¸</button>
                </div>
            </div>
            <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª -->
        <div id="videosSection" class="tab-section hidden">
            <div class="glass p-6 rounded-2xl mb-6">
                <h3 class="font-bold mb-4 text-lg text-blue-400">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø©</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="videoTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="p-3 rounded-xl bg-slate-700 text-white">
                    <input type="text" id="videoUrl" placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨" class="p-3 rounded-xl bg-slate-700 text-white">
                    <input type="text" id="videoCenter" placeholder="Ø§Ù„Ø³Ù†ØªØ±" class="p-3 rounded-xl bg-slate-700 text-white">
                    <select id="videoYear" class="p-3 rounded-xl bg-slate-700 text-white">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
                        <option value="1">Ø§Ù„Ø£ÙˆÙ„</option>
                        <option value="2">Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                        <option value="3">Ø§Ù„Ø«Ø§Ù„Ø«</option>
                    </select>
                    <input type="number" id="videoMaxViews" placeholder="Ø­Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª" value="10" class="p-3 rounded-xl bg-slate-700 text-white">
                    <button onclick="addVideo()" class="bg-blue-600 text-white font-bold rounded-xl p-3 col-span-3">Ù†Ø´Ø±</button>
                </div>
            </div>
            <div id="videosList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø¶ÙˆØ± -->
        <div id="attendanceSection" class="tab-section hidden">
            <div class="glass p-6 rounded-2xl">
                <div class="flex justify-between mb-6">
                    <h3 class="font-bold text-lg text-green-400">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                    <div class="flex gap-3">
                        <input type="date" id="attendanceDate" class="p-3 rounded-xl bg-slate-700 text-white">
                        <button onclick="openCamera()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700">
                            <i class="fas fa-camera ml-2"></i> Ù…Ø³Ø­ QR
                        </button>
                    </div>
                </div>
                <div id="attendanceList" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ -->
    <div id="studentPanel" class="hidden w-full max-w-4xl mx-auto p-4">
        <div class="glass sticky top-0 z-40 p-6 mb-6 rounded-2xl">
            <div class="flex justify-between">
                <div>
                    <h2 id="studentName" class="text-2xl font-black text-blue-400"></h2>
                    <p id="studentInfo" class="text-sm text-gray-400"></p>
                </div>
                <div class="flex gap-4">
                    <div id="studentQRCode" class="w-16 h-16 bg-white p-1 rounded-xl"></div>
                    <button onclick="logout()" class="bg-red-500/20 text-red-500 px-6 py-3 rounded-xl">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h3 class="font-bold text-lg text-blue-400 mb-4">ğŸ¬ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                <div id="studentVideosList" class="space-y-4"></div>
            </div>
            <div>
                <h3 class="font-bold text-lg text-green-400 mb-4">ğŸ“… Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ùƒ</h3>
                <div id="studentAttendance" class="glass p-4 rounded-2xl space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <div id="cameraModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="glass rounded-3xl w-full max-w-2xl p-6">
            <div class="flex justify-between mb-4">
                <h3 class="text-xl font-bold text-green-400">ğŸ“· Ù…Ø³Ø­ QR</h3>
                <button onclick="closeCamera()" class="text-white text-3xl">&times;</button>
            </div>
            <div id="reader"></div>
            <div id="scanResult" class="mt-4 p-4 text-center font-bold"></div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
    <div id="videoModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="glass rounded-3xl w-full max-w-5xl p-6">
            <div class="flex justify-between mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-blue-400"></h3>
                <button onclick="closeModal()" class="text-white text-3xl">&times;</button>
            </div>
            <div id="modalVideo" class="aspect-video bg-black rounded-xl"></div>
            <div class="mt-4 flex gap-4">
                <span id="modalViews" class="text-gray-400"></span>
                <span id="modalRemaining" class="text-amber-400"></span>
            </div>
        </div>
    </div>

    <script>
        // ==================== ØªÙ‡ÙŠØ¦Ø© Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDJiGrK0AnGQvWszbp6o7RFZJQO5Rm0yBQ",
            authDomain: "mohamedrostom-b6027.firebaseapp.com",
            databaseURL: "https://mohamedrostom-b6027-default-rtdb.firebaseio.com",
            projectId: "mohamedrostom-b6027",
            storageBucket: "mohamedrostom-b6027.appspot.com",
            messagingSenderId: "63872187835",
            appId: "1:63872187835:web:21be801c57783c853ed89e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==================== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
        let students = [];
        let videos = [];
        let attendance = {};
        let currentUser = null;
        let html5QrCode = null;

        // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase ====================
        function loadData() {
            document.getElementById('loadingStatus').innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨...';
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
            database.ref('students').on('value', (snapshot) => {
                const data = snapshot.val();
                students = data ? Object.values(data) : [];
                document.getElementById('loadingStatus').innerHTML = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨';
                updateHomeStats();
                if (!document.getElementById('teacherPanel').classList.contains('hidden')) {
                    updateTeacherUI();
                }
            });

            database.ref('videos').on('value', (snapshot) => {
                const data = snapshot.val();
                videos = data ? Object.values(data) : [];
                document.getElementById('loadingStatus').innerHTML = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª';
            });

            database.ref('attendance').on('value', (snapshot) => {
                const data = snapshot.val();
                attendance = data || {};
                document.getElementById('loadingStatus').innerHTML = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±';
                
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 1000);
            });
        }

        // ==================== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase ====================
        function saveStudents() {
            const studentsObj = {};
            students.forEach(s => { studentsObj[s.id] = s; });
            database.ref('students').set(studentsObj);
        }

        function saveVideos() {
            const videosObj = {};
            videos.forEach(v => { videosObj[v.id] = v; });
            database.ref('videos').set(videosObj);
        }

        function saveAttendance() {
            database.ref('attendance').set(attendance);
        }

        // ==================== Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ© ====================
        function syncData() {
            showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...', 'info');
            saveStudents();
            saveVideos();
            saveAttendance();
            showToast('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }

        // ==================== Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMessage');
            toastMsg.textContent = message;
            toast.classList.remove('hidden');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====================
        function updateHomeStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendance[today] ? Object.keys(attendance[today]).length : 0;
            document.getElementById('homeStudentsCount').textContent = students.length;
            document.getElementById('homeVideosCount').textContent = videos.length;
            document.getElementById('homeAttendanceToday').textContent = todayAttendance;
        }

        // ==================== Ø§Ù„Ø¯Ø®ÙˆÙ„ ====================
        function login() {
            const type = document.getElementById('userType').value;
            const pass = document.getElementById('password').value;

            if(type === 'teacher' && pass === '1234') {
                document.getElementById('homePage').classList.add('hidden');
                document.getElementById('teacherPanel').classList.remove('hidden');
                updateTeacherUI();
                showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ù…Ø³ØªØ± Ù…Ø­Ù…Ø¯');
            } 
            else if(type === 'student') {
                const student = students.find(s => s.code === pass);
                if(student) {
                    currentUser = student;
                    document.getElementById('homePage').classList.add('hidden');
                    document.getElementById('studentPanel').classList.remove('hidden');
                    
                    document.getElementById('studentName').innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ ${student.name}`;
                    document.getElementById('studentInfo').innerHTML = `${student.center} - Ø³Ù†Ø© ${student.year}`;
                    
                    document.getElementById('studentQRCode').innerHTML = '';
                    new QRCode(document.getElementById('studentQRCode'), {
                        text: String(student.code),
                        width: 60,
                        height: 60
                    });
                    
                    updateStudentUI();
                    showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${student.name}`);
                } else {
                    showToast('ÙƒÙˆØ¯ Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                }
            }
        }

        function logout() {
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('teacherPanel').classList.add('hidden');
            document.getElementById('studentPanel').classList.add('hidden');
            if(html5QrCode) html5QrCode.stop();
            updateHomeStats();
        }

        // ==================== Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ====================
        function openCamera() {
            document.getElementById('cameraModal').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                onScanSuccess,
                onScanError
            ).catch(() => showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'error'));
        }

        function onScanSuccess(decodedText) {
            const student = students.find(s => s.code === decodedText);
            const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            
            if(student) {
                if(!attendance[date]) attendance[date] = {};
                attendance[date][student.id] = {
                    name: student.name,
                    time: new Date().toLocaleTimeString('ar-EG'),
                    method: 'QR'
                };
                saveAttendance();
                
                document.getElementById('scanResult').innerHTML = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${student.name}`;
                if(!document.getElementById('attendanceSection').classList.contains('hidden')) {
                    updateAttendanceUI();
                }
                showToast(`ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${student.name}`);
                
                setTimeout(() => document.getElementById('scanResult').innerHTML = '', 2000);
            } else {
                document.getElementById('scanResult').innerHTML = 'âŒ ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­';
                setTimeout(() => document.getElementById('scanResult').innerHTML = '', 2000);
            }
        }

        function onScanError() {}

        function closeCamera() {
            if(html5QrCode) html5QrCode.stop().then(() => {
                document.getElementById('cameraModal').classList.add('hidden');
            });
        }

        // ==================== Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ====================
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            document.querySelectorAll('.tab-section').forEach(s => s.classList.add('hidden'));
            
            if(tab === 'students') {
                document.getElementById('tabStudents').classList.add('active-tab');
                document.getElementById('studentsSection').classList.remove('hidden');
            } else if(tab === 'videos') {
                document.getElementById('tabVideos').classList.add('active-tab');
                document.getElementById('videosSection').classList.remove('hidden');
            } else {
                document.getElementById('tabAttendance').classList.add('active-tab');
                document.getElementById('attendanceSection').classList.remove('hidden');
                updateAttendanceUI();
            }
        }

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ====================
        function addStudent() {
            const student = {
                id: Date.now(),
                name: document.getElementById('stdName').value,
                code: document.getElementById('stdCode').value,
                parent: document.getElementById('stdParent').value,
                center: document.getElementById('stdCenter').value,
                year: document.getElementById('stdYear').value,
                group: document.getElementById('stdGroup').value || 'A'
            };
            
            if(student.name && student.code) {
                students.push(student);
                saveStudents();
                updateTeacherUI();
                clearInputs();
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨');
            }
        }

        function updateTeacherUI() {
            const totalViews = videos.reduce((sum, v) => sum + (v.views || 0), 0);
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendance[today] ? Object.keys(attendance[today]).length : 0;
            
            document.getElementById('totalStudents').innerText = students.length;
            document.getElementById('totalVideos').innerText = videos.length;
            document.getElementById('totalViews').innerText = totalViews;
            document.getElementById('todayAttendance').innerText = todayAttendance;
            document.getElementById('attendancePercentage').innerText = students.length ? Math.round((todayAttendance/students.length)*100) + '%' : '0%';
            
            document.getElementById('studentsList').innerHTML = students.map(s => {
                setTimeout(() => {
                    const qrDiv = document.getElementById(`qr-${s.id}`);
                    if(qrDiv) {
                        qrDiv.innerHTML = '';
                        new QRCode(qrDiv, { text: String(s.code), width: 80, height: 80 });
                    }
                }, 100);
                
                return `
                    <div class="glass p-4 rounded-xl">
                        <div class="flex justify-between">
                            <div>
                                <h4 class="font-bold text-amber-400">${s.name}</h4>
                                <p class="text-sm">ğŸ”‘ ${s.code}</p>
                                <p class="text-sm">ğŸ“ ${s.parent}</p>
                                <p class="text-sm">ğŸ« ${s.center} - Ø³Ù†Ø© ${s.year}</p>
                            </div>
                            <div id="qr-${s.id}" class="bg-white p-1 rounded-lg"></div>
                        </div>
                        <button onclick="deleteStudent(${s.id})" class="mt-2 text-sm text-red-500">Ø­Ø°Ù</button>
                    </div>
                `;
            }).join('');
        }

        function deleteStudent(id) {
            if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) {
                students = students.filter(s => s.id !== id);
                saveStudents();
                updateTeacherUI();
                showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            }
        }

        function clearInputs() {
            document.getElementById('stdName').value = '';
            document.getElementById('stdCode').value = '';
            document.getElementById('stdParent').value = '';
            document.getElementById('stdCenter').value = '';
        }

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ====================
        function addVideo() {
            const url = document.getElementById('videoUrl').value;
            let videoId = '';
            
            if(url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
            else if(url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split('?')[0];
            
            if(videoId) {
                const video = {
                    id: Date.now(),
                    title: document.getElementById('videoTitle').value,
                    videoId: videoId,
                    center: document.getElementById('videoCenter').value || 'all',
                    year: document.getElementById('videoYear').value,
                    maxViews: parseInt(document.getElementById('videoMaxViews').value) || 10,
                    views: 0
                };
                
                videos.push(video);
                saveVideos();
                updateVideosList();
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
            }
        }

        function updateVideosList() {
            document.getElementById('videosList').innerHTML = videos.map(v => `
                <div class="glass p-4 rounded-xl">
                    <img src="https://img.youtube.com/vi/${v.videoId}/mqdefault.jpg" class="w-full rounded-lg mb-3">
                    <h4 class="font-bold text-blue-400">${v.title}</h4>
                    <div class="flex justify-between mt-2">
                        <span>ğŸ‘ ${v.views || 0}/${v.maxViews}</span>
                        <span>ğŸ“š Ø³Ù†Ø© ${v.year}</span>
                    </div>
                    <button onclick="deleteVideo(${v.id})" class="mt-2 w-full bg-red-500/20 text-red-500 px-3 py-2 rounded-lg">Ø­Ø°Ù</button>
                </div>
            `).join('');
        }

        function deleteVideo(id) {
            if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) {
                videos = videos.filter(v => v.id !== id);
                saveVideos();
                updateVideosList();
                showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            }
        }

        // ==================== Ø§Ù„Ø­Ø¶ÙˆØ± ====================
        function updateAttendanceUI() {
            const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            const todayAttendance = attendance[date] || {};
            
            document.getElementById('attendanceList').innerHTML = students.map(s => {
                const isPresent = todayAttendance[s.id];
                return `
                    <div class="flex justify-between p-3 bg-slate-700 rounded-lg">
                        <span>${s.name}</span>
                        <button onclick="toggleAttendance('${date}', ${s.id})" 
                                class="px-3 py-1 rounded-lg text-sm ${isPresent ? 'bg-green-600' : 'bg-slate-600'}">
                            ${isPresent ? 'âœ… Ø­Ø§Ø¶Ø±' : 'â­• ØªØ³Ø¬ÙŠÙ„'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function toggleAttendance(date, studentId) {
            if(!attendance[date]) attendance[date] = {};
            
            if(attendance[date][studentId]) {
                delete attendance[date][studentId];
            } else {
                const student = students.find(s => s.id === studentId);
                attendance[date][studentId] = {
                    name: student.name,
                    time: new Date().toLocaleTimeString('ar-EG'),
                    method: 'ÙŠØ¯ÙˆÙŠ'
                };
            }
            
            saveAttendance();
            updateAttendanceUI();
            updateTeacherUI();
        }

        // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ ====================
        function updateStudentUI() {
            const studentVideos = videos.filter(v => 
                (v.year === 'all' || v.year == currentUser.year) && 
                (v.center === 'all' || v.center === currentUser.center)
            );
            
            document.getElementById('studentVideosList').innerHTML = studentVideos.map(v => {
                const canWatch = (v.views || 0) < v.maxViews;
                return `
                    <div class="glass p-4 rounded-xl ${!canWatch ? 'opacity-50' : ''}">
                        <h4 class="font-bold">${v.title}</h4>
                        <img src="https://img.youtube.com/vi/${v.videoId}/mqdefault.jpg" 
                             class="w-full rounded-lg my-2 cursor-pointer"
                             onclick="${canWatch ? `watchVideo('${v.videoId}', '${v.title}', ${v.views || 0}, ${v.maxViews})` : ''}">
                        <div class="flex justify-between">
                            <span>ğŸ‘ ${v.views || 0}/${v.maxViews}</span>
                            <span class="${canWatch ? 'text-green-400' : 'text-red-400'}">${canWatch ? 'Ù…ØªØ§Ø­' : 'Ù…Ù†ØªÙ‡ÙŠ'}</span>
                        </div>
                    </div>
                `;
            }).join('');

            const studentAttendance = [];
            Object.keys(attendance).forEach(date => {
                if(attendance[date][currentUser.id]) {
                    studentAttendance.push(`
                        <div class="flex justify-between p-2 bg-slate-700 rounded">
                            <span>ğŸ“… ${date}</span>
                            <span class="text-green-400">âœ… ${attendance[date][currentUser.id].time}</span>
                        </div>
                    `);
                }
            });
            
            document.getElementById('studentAttendance').innerHTML = studentAttendance.join('') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„';
        }

        // ==================== Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ====================
        function watchVideo(videoId, title, currentViews, maxViews) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalVideo').innerHTML = `
                <iframe class="w-full h-full" src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allowfullscreen></iframe>
            `;
            document.getElementById('modalViews').innerText = `Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ${currentViews + 1}/${maxViews}`;
            document.getElementById('modalRemaining').innerText = `Ù…ØªØ¨Ù‚ÙŠ ${maxViews - (currentViews + 1)}`;
            document.getElementById('videoModal').classList.remove('hidden');

            const video = videos.find(v => v.videoId === videoId);
            if(video) {
                video.views = (video.views || 0) + 1;
                saveVideos();
            }
        }

        function closeModal() {
            document.getElementById('videoModal').classList.add('hidden');
            document.getElementById('modalVideo').innerHTML = '';
        }

        // ØªÙ‡ÙŠØ¦Ø©
        document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        loadData();
    </script>
</body>
</html>
