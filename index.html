<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ - Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        * { font-family: 'Cairo', sans-serif; }
        .gold-gradient { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        #reader { width: 100%; height: auto; border-radius: 1rem; overflow: hidden; }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #eab308;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999;
            transition: all 0.3s;
            border-right: 4px solid #eab308;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen text-white">

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingBar" class="fixed top-0 left-0 w-full h-1 bg-amber-500 z-50" style="width:0%; transition: width 0.3s;"></div>
    
    <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="toast" class="toast hidden"></div>

    <!-- ==================== Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==================== -->
    <div id="homePage" class="w-full max-w-4xl mx-auto p-4 min-h-screen flex items-center justify-center">
        <div class="text-center w-full">
            <h1 class="text-5xl font-black text-white mb-4">ğŸŒŸ Ù…Ù†ØµØ© <span class="text-amber-400">Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ</span> Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h1>
            <p class="text-gray-400 text-lg mb-8">Ù…Ø³ØªØ± Ù…Ø­Ù…Ø¯ Ø±Ø³ØªÙ…</p>

            <div class="max-w-md mx-auto bg-slate-800/50 p-6 rounded-3xl border border-slate-700">
                <div class="mb-4">
                    <select id="userType" class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600 text-white">
                        <option value="teacher">ğŸ‘¨â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³</option>
                        <option value="student">ğŸ‘¨â€ğŸ“ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</option>
                    </select>
                </div>
                <div class="mb-4">
                    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600 text-white">
                </div>
                <button onclick="login()" class="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-xl hover:bg-amber-400 transition">
                    Ø¯Ø®ÙˆÙ„
                </button>
                <p class="text-xs text-gray-500 mt-4">ğŸ” ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯Ø±Ø³: 1234</p>
            </div>
        </div>
    </div>

    <!-- ==================== Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ ==================== -->
    <div id="teacherPanel" class="hidden w-full max-w-6xl mx-auto p-4">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="glass sticky top-0 z-40 p-4 mb-6 rounded-2xl">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-amber-400">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯Ø±Ø³</h2>
                <div class="flex gap-2">
                    <button onclick="openCamera()" class="bg-green-600 text-white px-4 py-2 rounded-xl flex items-center gap-2">
                        ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø­Ø¶ÙˆØ±
                    </button>
                    <button onclick="logout()" class="bg-red-500/20 text-red-500 px-4 py-2 rounded-xl">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="grid grid-cols-4 gap-3 mb-6">
            <div class="bg-slate-800 p-3 rounded-xl text-center">
                <span class="text-xs text-gray-400">Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                <p id="totalStudents" class="text-xl font-black text-amber-400">0</p>
            </div>
            <div class="bg-slate-800 p-3 rounded-xl text-center">
                <span class="text-xs text-gray-400">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</span>
                <p id="totalVideos" class="text-xl font-black text-blue-400">0</p>
            </div>
            <div class="bg-slate-800 p-3 rounded-xl text-center">
                <span class="text-xs text-gray-400">Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</span>
                <p id="totalViews" class="text-xl font-black text-green-400">0</p>
            </div>
            <div class="bg-slate-800 p-3 rounded-xl text-center">
                <span class="text-xs text-gray-400">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</span>
                <p id="todayAttendance" class="text-xl font-black text-purple-400">0</p>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
        <div class="flex bg-slate-800 rounded-2xl overflow-hidden mb-6">
            <button onclick="showTeacherTab('students')" id="tabStudents" class="tab-btn active-tab flex-1 py-3 font-bold">ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            <button onclick="showTeacherTab('videos')" id="tabVideos" class="tab-btn flex-1 py-3 font-bold">ğŸ¬ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</button>
            <button onclick="showTeacherTab('attendance')" id="tabAttendance" class="tab-btn flex-1 py-3 font-bold">ğŸ“… Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø¹ QR Code -->
        <div id="studentsSection" class="tab-section">
            <div class="bg-slate-800 p-6 rounded-2xl mb-6">
                <h3 class="font-bold mb-4 text-lg text-amber-400">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="stdName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <input type="text" id="stdCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <input type="text" id="stdParent" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <input type="text" id="stdCenter" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù†ØªØ±" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <select id="stdYear" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                    </select>
                    <input type="email" id="stdEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <input type="text" id="stdGroup" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©" value="A" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <button onclick="addStudent()" class="bg-amber-500 text-slate-900 font-bold rounded-xl p-3 hover:bg-amber-400 transition">Ø­ÙØ¸</button>
                </div>
            </div>
            <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª -->
        <div id="videosSection" class="tab-section hidden">
            <div class="bg-slate-800 p-6 rounded-2xl mb-6">
                <h3 class="font-bold mb-4 text-lg text-blue-400">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø©</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="videoTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <input type="text" id="videoUrl" placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <input type="text" id="videoCenter" placeholder="Ø§Ù„Ø³Ù†ØªØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <select id="videoYear" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                    </select>
                    <input type="number" id="videoMaxViews" placeholder="Ø­Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª" value="10" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <input type="date" id="videoDate" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <input type="time" id="videoTime" value="20:00" class="p-3 rounded-xl bg-slate-700 border-slate-600 text-white">
                    <button onclick="addVideo()" class="bg-blue-600 text-white font-bold rounded-xl p-3 hover:bg-blue-700 transition">Ù†Ø´Ø±</button>
                </div>
            </div>
            <div id="videosList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø¶ÙˆØ± -->
        <div id="attendanceSection" class="tab-section hidden">
            <div class="bg-slate-800 p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                    <button onclick="openCamera()" class="bg-green-600 text-white px-4 py-2 rounded-xl flex items-center gap-2">
                        ğŸ“· Ù…Ø³Ø­ QR
                    </button>
                </div>
                <div class="mb-4">
                    <input type="date" id="attendanceDate" class="p-2 rounded-lg bg-slate-700 text-white">
                </div>
                <div id="attendanceList" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- ==================== Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ==================== -->
    <div id="studentPanel" class="hidden w-full max-w-4xl mx-auto p-4">
        <div class="glass sticky top-0 z-40 p-4 mb-6 rounded-2xl">
            <div class="flex justify-between items-center">
                <div>
                    <h2 id="studentName" class="text-2xl font-black text-blue-400"></h2>
                    <p id="studentInfo" class="text-sm text-gray-400"></p>
                </div>
                <div class="flex gap-2">
                    <div id="studentQRCode" class="w-12 h-12 bg-white p-1 rounded-lg"></div>
                    <button onclick="logout()" class="bg-red-500/20 text-red-500 px-4 py-2 rounded-xl">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div id="studentVideos" class="space-y-4">
                <h3 class="font-bold text-lg text-blue-400">ğŸ¬ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                <div id="studentVideosList" class="space-y-4"></div>
            </div>
            <div>
                <h3 class="font-bold text-lg text-green-400">ğŸ“… Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ùƒ</h3>
                <div id="studentAttendance" class="bg-slate-800 p-4 rounded-2xl mt-4 space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <div id="cameraModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-3xl w-full max-w-2xl p-4">
            <div class="flex justify-between mb-4">
                <h3 class="text-xl font-bold text-green-400">ğŸ“· Ù…Ø³Ø­ QR ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <button onclick="closeCamera()" class="text-white text-3xl">&times;</button>
            </div>
            <div id="reader" class="w-full rounded-xl overflow-hidden bg-black"></div>
            <div id="scanResult" class="mt-4 p-3 rounded-xl text-center font-bold"></div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
    <div id="videoModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-3xl w-full max-w-4xl p-4">
            <div class="flex justify-between mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-blue-400"></h3>
                <button onclick="closeModal()" class="text-white text-3xl">&times;</button>
            </div>
            <div id="modalVideo" class="aspect-video bg-black rounded-xl"></div>
            <div class="mt-4 flex justify-between text-sm">
                <span id="modalViews" class="text-gray-400"></span>
                <span id="modalRemaining" class="text-amber-400 font-bold"></span>
            </div>
        </div>
    </div>

    <script>
        // ==================== ØªÙ‡ÙŠØ¦Ø© Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "000000000000",
            appId: "1:000000000000:web:aaaaaaaaaaaaaaaaaaaaaa"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… LocalStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        let useLocalStorage = false;

        // ==================== Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„ ====================
        function setProgress(percent) {
            document.getElementById('loadingBar').style.width = percent + '%';
        }

        // ==================== Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerHTML = message;
            toast.classList.remove('hidden');
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase ====================
        async function loadData() {
            setProgress(30);
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
                const studentsSnapshot = await db.collection('students').get();
                students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setProgress(60);
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
                const videosSnapshot = await db.collection('videos').get();
                videos = videosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setProgress(80);
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
                const attendanceSnapshot = await db.collection('attendance').get();
                attendance = {};
                attendanceSnapshot.docs.forEach(doc => {
                    attendance[doc.id] = doc.data();
                });
                
                setProgress(100);
                setTimeout(() => setProgress(0), 500);
                
                updateHomeStats();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ LocalStorage
                useLocalStorage = true;
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            students = JSON.parse(localStorage.getItem('students')) || [];
            videos = JSON.parse(localStorage.getItem('videos')) || [];
            attendance = JSON.parse(localStorage.getItem('attendance')) || {};
            showToast('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'info');
            updateHomeStats();
        }

        // ==================== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase ====================
        async function saveStudents() {
            if (useLocalStorage) {
                localStorage.setItem('students', JSON.stringify(students));
                return;
            }
            
            try {
                for (const student of students) {
                    await db.collection('students').doc(String(student.id)).set(student);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø§Ø¨:', error);
                useLocalStorage = true;
            }
        }

        async function saveVideos() {
            if (useLocalStorage) {
                localStorage.setItem('videos', JSON.stringify(videos));
                return;
            }
            
            try {
                for (const video of videos) {
                    await db.collection('videos').doc(String(video.id)).set(video);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:', error);
                useLocalStorage = true;
            }
        }

        async function saveAttendance() {
            if (useLocalStorage) {
                localStorage.setItem('attendance', JSON.stringify(attendance));
                return;
            }
            
            try {
                for (const [date, data] of Object.entries(attendance)) {
                    await db.collection('attendance').doc(date).set(data);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±:', error);
                useLocalStorage = true;
            }
        }

        // ==================== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ====================
        let students = [];
        let videos = [];
        let attendance = {};
        let currentUser = null;
        let html5QrCode = null;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        loadData();

        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function updateHomeStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendance[today] ? Object.keys(attendance[today]).length : 0;
            
            document.getElementById('homeStudentsCount')?.remove();
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
        }

        // ==================== Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ ====================
        function login() {
            const type = document.getElementById('userType').value;
            const pass = document.getElementById('password').value;

            if(type === 'teacher' && pass === '1234') {
                document.getElementById('homePage').classList.add('hidden');
                document.getElementById('teacherPanel').classList.remove('hidden');
                updateTeacherUI();
                showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ù…Ø³ØªØ± Ù…Ø­Ù…Ø¯');
            } else if(type === 'student') {
                const student = students.find(s => s.code === pass);
                if(student) {
                    currentUser = student;
                    document.getElementById('homePage').classList.add('hidden');
                    document.getElementById('studentPanel').classList.remove('hidden');
                    document.getElementById('studentName').innerText = `Ø£Ù‡Ù„Ø§Ù‹ ${student.name}`;
                    document.getElementById('studentInfo').innerText = `${student.center || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} - Ø³Ù†Ø© ${student.year} - Ù…Ø¬Ù…ÙˆØ¹Ø© ${student.group || 'A'}`;
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ QR Code Ù„Ù„Ø·Ø§Ù„Ø¨
                    document.getElementById('studentQRCode').innerHTML = '';
                    new QRCode(document.getElementById('studentQRCode'), {
                        text: String(student.code),
                        width: 48,
                        height: 48
                    });
                    
                    updateStudentUI();
                    showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${student.name}`);
                } else {
                    showToast('ÙƒÙˆØ¯ Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                }
            } else {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
            }
        }

        function logout() {
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('teacherPanel').classList.add('hidden');
            document.getElementById('studentPanel').classList.add('hidden');
            if(html5QrCode) {
                html5QrCode.stop();
            }
            showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
        }

        // ==================== Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ====================
        function openCamera() {
            document.getElementById('cameraModal').classList.remove('hidden');
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                onScanSuccess,
                onScanError
            ).catch(err => {
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'error');
            });
        }

        async function onScanSuccess(decodedText) {
            const student = students.find(s => s.code === decodedText);
            const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            
            if(student) {
                if(!attendance[date]) attendance[date] = {};
                
                attendance[date][student.id] = {
                    name: student.name,
                    time: new Date().toLocaleTimeString('ar-EG'),
                    method: 'QR',
                    center: student.center,
                    year: student.year
                };
                
                await saveAttendance();
                
                document.getElementById('scanResult').innerHTML = `
                    âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${student.name}
                    <br>
                    <span class="text-sm text-green-400">${new Date().toLocaleTimeString('ar-EG')}</span>
                `;
                
                if(document.getElementById('attendanceSection').classList.contains('hidden') === false) {
                    updateAttendanceUI();
                }
                
                showToast(`ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${student.name}`);
                
                setTimeout(() => {
                    document.getElementById('scanResult').innerHTML = '';
                }, 3000);
            } else {
                document.getElementById('scanResult').innerHTML = 'âŒ ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­';
                setTimeout(() => {
                    document.getElementById('scanResult').innerHTML = '';
                }, 2000);
            }
        }

        function onScanError(error) {}

        function closeCamera() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('cameraModal').classList.add('hidden');
                });
            } else {
                document.getElementById('cameraModal').classList.add('hidden');
            }
        }

        // ==================== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ ====================
        function showTeacherTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            document.querySelectorAll('.tab-section').forEach(s => s.classList.add('hidden'));
            
            if(tab === 'students') {
                document.getElementById('tabStudents').classList.add('active-tab');
                document.getElementById('studentsSection').classList.remove('hidden');
            } else if(tab === 'videos') {
                document.getElementById('tabVideos').classList.add('active-tab');
                document.getElementById('videosSection').classList.remove('hidden');
            } else {
                document.getElementById('tabAttendance').classList.add('active-tab');
                document.getElementById('attendanceSection').classList.remove('hidden');
                updateAttendanceUI();
            }
        }

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ====================
        async function addStudent() {
            const student = {
                id: Date.now(),
                name: document.getElementById('stdName').value,
                code: document.getElementById('stdCode').value,
                parent: document.getElementById('stdParent').value,
                center: document.getElementById('stdCenter').value,
                year: document.getElementById('stdYear').value,
                email: document.getElementById('stdEmail').value,
                group: document.getElementById('stdGroup').value || 'A',
                createdAt: new Date().toISOString()
            };
            
            if(student.name && student.code) {
                students.push(student);
                await saveStudents();
                updateTeacherUI();
                clearStudentInputs();
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯', 'error');
            }
        }

        function updateTeacherUI() {
            document.getElementById('totalStudents').innerText = students.length;
            document.getElementById('totalVideos').innerText = videos.length;
            document.getElementById('totalViews').innerText = videos.reduce((sum, v) => sum + (v.views || 0), 0);
            
            document.getElementById('studentsList').innerHTML = students.map(s => {
                setTimeout(() => {
                    const qrDiv = document.getElementById(`qr-${s.id}`);
                    if(qrDiv) {
                        qrDiv.innerHTML = '';
                        new QRCode(qrDiv, {
                            text: String(s.code),
                            width: 100,
                            height: 100
                        });
                    }
                }, 100);
                
                return `
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-amber-400 transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-amber-400 text-lg">${s.name}</h4>
                                <p class="text-sm"><span class="text-gray-400">ğŸ”‘ ÙƒÙˆØ¯:</span> ${s.code}</p>
                                <p class="text-sm"><span class="text-gray-400">ğŸ“ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span> ${s.parent || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                                <p class="text-sm"><span class="text-gray-400">ğŸ« Ø§Ù„Ø³Ù†ØªØ±:</span> ${s.center || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                                <p class="text-sm"><span class="text-gray-400">ğŸ“š Ø§Ù„Ø³Ù†Ø©:</span> ${s.year}</p>
                                <p class="text-sm"><span class="text-gray-400">ğŸ‘¥ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</span> ${s.group || 'A'}</p>
                            </div>
                            <div id="qr-${s.id}" class="bg-white p-1 rounded-lg"></div>
                        </div>
                        <button onclick="deleteStudent(${s.id})" class="mt-3 w-full bg-red-500/20 text-red-500 px-3 py-2 rounded-lg hover:bg-red-500/30 transition">
                            <i class="fas fa-trash ml-1"></i> Ø­Ø°Ù
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function deleteStudent(id) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                students = students.filter(s => s.id !== id);
                await saveStudents();
                updateTeacherUI();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨');
            }
        }

        function clearStudentInputs() {
            document.getElementById('stdName').value = '';
            document.getElementById('stdCode').value = '';
            document.getElementById('stdParent').value = '';
            document.getElementById('stdCenter').value = '';
            document.getElementById('stdEmail').value = '';
        }

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ====================
        async function addVideo() {
            const url = document.getElementById('videoUrl').value;
            let videoId = '';
            
            if(url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
            else if(url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split('?')[0];
            
            if(videoId) {
                const video = {
                    id: Date.now(),
                    title: document.getElementById('videoTitle').value,
                    videoId: videoId,
                    center: document.getElementById('videoCenter').value || 'all',
                    year: document.getElementById('videoYear').value,
                    maxViews: parseInt(document.getElementById('videoMaxViews').value) || 10,
                    views: 0,
                    date: document.getElementById('videoDate').value || new Date().toISOString().split('T')[0],
                    time: document.getElementById('videoTime').value || '20:00',
                    createdAt: new Date().toISOString()
                };
                
                videos.push(video);
                await saveVideos();
                updateTeacherUI();
                updateVideosList();
                
                document.getElementById('videoTitle').value = '';
                document.getElementById('videoUrl').value = '';
                document.getElementById('videoCenter').value = '';
                
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                showToast('Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
            }
        }

        function updateVideosList() {
            document.getElementById('videosList').innerHTML = videos.map(v => `
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-blue-400 transition">
                    <img src="https://img.youtube.com/vi/${v.videoId}/mqdefault.jpg" 
                         class="w-full rounded-lg mb-3 cursor-pointer"
                         onclick="window.open('https://youtu.be/${v.videoId}')">
                    <h4 class="font-bold text-blue-400">${v.title}</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm mt-2">
                        <span>ğŸ‘ ${v.views || 0}/${v.maxViews}</span>
                        <span>ğŸ“… ${v.date}</span>
                        <span>â° ${v.time}</span>
                        <span>ğŸ“š Ø³Ù†Ø© ${v.year === 'all' ? 'Ø§Ù„ÙƒÙ„' : v.year}</span>
                    </div>
                    <button onclick="deleteVideo(${v.id})" class="mt-3 w-full bg-red-500/20 text-red-500 px-3 py-2 rounded-lg hover:bg-red-500/30 transition">
                        Ø­Ø°Ù
                    </button>
                </div>
            `).join('');
        }

        async function deleteVideo(id) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                videos = videos.filter(v => v.id !== id);
                await saveVideos();
                updateTeacherUI();
                updateVideosList();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
            }
        }

        // ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ====================
        function updateAttendanceUI() {
            const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            const todayAttendance = attendance[date] || {};
            
            document.getElementById('todayAttendance').innerText = Object.keys(todayAttendance).length;
            
            document.getElementById('attendanceList').innerHTML = students.map(s => {
                const isPresent = todayAttendance[s.id];
                return `
                    <div class="flex justify-between items-center p-3 bg-slate-700 rounded-lg hover:bg-slate-600 transition">
                        <div>
                            <span class="font-bold">${s.name}</span>
                            <span class="text-xs text-gray-400 mr-2">${s.center || ''} - Ù…Ø¬Ù…ÙˆØ¹Ø© ${s.group || 'A'}</span>
                            ${isPresent ? `
                                <span class="text-xs text-green-400 block">
                                    âœ… ${isPresent.time} (${isPresent.method})
                                </span>
                            ` : ''}
                        </div>
                        <button onclick="toggleAttendance('${date}', ${s.id})" 
                                class="px-4 py-2 rounded-lg text-sm font-bold ${isPresent ? 'bg-green-600 hover:bg-green-700' : 'bg-amber-600 hover:bg-amber-700'} transition">
                            ${isPresent ? 'âœ… Ø­Ø§Ø¶Ø±' : 'â­• ØªØ³Ø¬ÙŠÙ„'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function toggleAttendance(date, studentId) {
            if(!attendance[date]) attendance[date] = {};
            
            if(attendance[date][studentId]) {
                delete attendance[date][studentId];
                showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¶ÙˆØ±');
            } else {
                const student = students.find(s => s.id === studentId);
                attendance[date][studentId] = {
                    name: student.name,
                    time: new Date().toLocaleTimeString('ar-EG'),
                    method: 'ÙŠØ¯ÙˆÙŠ',
                    center: student.center,
                    year: student.year
                };
                showToast(`ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${student.name}`);
            }
            
            await saveAttendance();
            updateAttendanceUI();
            updateTeacherUI();
        }

        // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ ====================
        function updateStudentUI() {
            const studentVideos = videos.filter(v => 
                (v.year === 'all' || v.year == currentUser.year) && 
                (!v.center || v.center === 'all' || v.center === currentUser.center)
            );
            
            document.getElementById('studentVideosList').innerHTML = studentVideos.map(v => {
                const canWatch = (v.views || 0) < v.maxViews;
                return `
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 ${!canWatch ? 'opacity-50' : 'hover:border-blue-400'} transition">
                        <h4 class="font-bold text-lg">${v.title}</h4>
                        <img src="https://img.youtube.com/vi/${v.videoId}/mqdefault.jpg" 
                             class="w-full rounded-lg my-3 cursor-pointer"
                             onclick="${canWatch ? `watchVideo('${v.videoId}', '${v.title}', ${v.views || 0}, ${v.maxViews})` : 'showToast(\'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª\', \'error\')'}">
                        <div class="flex justify-between text-sm">
                            <span>ğŸ‘ ${v.views || 0}/${v.maxViews}</span>
                            <span class="${canWatch ? 'text-green-400' : 'text-red-400'}">${canWatch ? 'Ù…ØªØ§Ø­' : 'Ù…Ù†ØªÙ‡ÙŠ'}</span>
                        </div>
                    </div>
                `;
            }).join('');

            const studentAttendance = [];
            Object.keys(attendance).sort().reverse().slice(0, 5).forEach(date => {
                if(attendance[date][currentUser.id]) {
                    studentAttendance.push(`
                        <div class="flex justify-between p-2 bg-slate-700 rounded">
                            <span>ğŸ“… ${date}</span>
                            <span class="text-green-400">âœ… ${attendance[date][currentUser.id].time}</span>
                        </div>
                    `);
                }
            });
            
            document.getElementById('studentAttendance').innerHTML = studentAttendance.join('') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±';
        }

        // ==================== Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ====================
        async function watchVideo(videoId, title, currentViews, maxViews) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalVideo').innerHTML = `
                <iframe class="w-full h-full rounded-lg" src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allowfullscreen></iframe>
            `;
            document.getElementById('modalViews').innerText = `Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ${currentViews + 1}/${maxViews}`;
            document.getElementById('modalRemaining').innerText = `Ù…ØªØ¨Ù‚ÙŠ ${maxViews - (currentViews + 1)}`;
            document.getElementById('videoModal').classList.remove('hidden');

            const video = videos.find(v => v.videoId === videoId);
            if(video) {
                video.views = (video.views || 0) + 1;
                await saveVideos();
            }
        }

        function closeModal() {
            document.getElementById('videoModal').classList.add('hidden');
            document.getElementById('modalVideo').innerHTML = '';
        }

        // ØªÙ‡ÙŠØ¦Ø©
        document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
    </script>

    <style>
        .active-tab { background: #eab308; color: #0f172a; font-weight: 900; }
        .tab-btn { transition: all 0.3s; cursor: pointer; }
        .tab-btn:hover { background: rgba(234, 179, 8, 0.2); }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
        .hover-card {
            transition: all 0.3s;
        }
        .hover-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(234, 179, 8, 0.3);
        }
    </style>
</body>
</html>
